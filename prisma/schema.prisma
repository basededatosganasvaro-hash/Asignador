generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_SISTEMA_URL")
}

// =============================================
// ORGANIZACION
// =============================================

model regiones {
  id         Int        @id @default(autoincrement())
  nombre     String     @db.VarChar(200)
  activo     Boolean    @default(true)
  created_at DateTime   @default(now())

  zonas    zonas[]
  usuarios usuarios[]
}

model zonas {
  id        Int    @id @default(autoincrement())
  region_id Int
  nombre    String @db.VarChar(200)
  activo    Boolean @default(true)

  region     regiones     @relation(fields: [region_id], references: [id])
  sucursales sucursales[]

  @@index([region_id])
}

model sucursales {
  id        Int     @id @default(autoincrement())
  zona_id   Int
  nombre    String  @db.VarChar(200)
  direccion String?
  activo    Boolean @default(true)

  zona           zonas            @relation(fields: [zona_id], references: [id])
  equipos        equipos[]
  usuarios       usuarios[]
  planes_trabajo planes_trabajo[]

  @@index([zona_id])
}

model equipos {
  id            Int     @id @default(autoincrement())
  sucursal_id   Int
  nombre        String  @db.VarChar(200)
  supervisor_id Int?
  activo        Boolean @default(true)

  sucursal   sucursales @relation(fields: [sucursal_id], references: [id])
  miembros   usuarios[] @relation("EquipoMiembros")
  supervisor usuarios?  @relation("EquipoSupervisor", fields: [supervisor_id], references: [id])

  @@index([sucursal_id])
}

// =============================================
// USUARIOS
// =============================================

model usuarios {
  id            Int      @id @default(autoincrement())
  nombre        String   @db.VarChar(200)
  email         String   @unique @db.VarChar(300)
  password_hash String
  rol           String   @default("promotor") @db.VarChar(30)
  // admin | gerente_regional | gerente_sucursal | supervisor | promotor

  equipo_id   Int?
  sucursal_id Int?
  region_id   Int?

  activo     Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  equipo                  equipos?   @relation("EquipoMiembros", fields: [equipo_id], references: [id])
  sucursal                sucursales? @relation(fields: [sucursal_id], references: [id])
  region                  regiones?  @relation(fields: [region_id], references: [id])
  equipos_supervisados    equipos[]  @relation("EquipoSupervisor")

  lotes                   lotes[]
  oportunidades           oportunidades[]
  datos_contacto_editados datos_contacto[]
  planes_trabajo_creados  planes_trabajo[]

  @@index([email])
  @@index([rol])
}

// =============================================
// PLAN DE TRABAJO
// =============================================

model planes_trabajo {
  id          Int      @id @default(autoincrement())
  sucursal_id Int
  convenio    String   @db.VarChar(300)
  creado_por  Int
  activo      Boolean  @default(true)
  created_at  DateTime @default(now())

  sucursal sucursales @relation(fields: [sucursal_id], references: [id])
  creador  usuarios   @relation(fields: [creado_por], references: [id])

  @@index([sucursal_id, activo])
}

// =============================================
// OPORTUNIDADES (centro del sistema)
// =============================================

model lotes {
  id         Int      @id @default(autoincrement())
  usuario_id Int
  fecha      DateTime @default(now()) @db.Date
  cantidad   Int
  created_at DateTime @default(now())

  usuario       usuarios        @relation(fields: [usuario_id], references: [id])
  oportunidades oportunidades[]

  @@index([usuario_id])
  @@index([usuario_id, fecha])
}

model oportunidades {
  id         Int      @id @default(autoincrement())
  cliente_id Int
  // Referencia a clientes.id en BD Clientes (sin FK constraint — DBs separadas)
  usuario_id Int
  origen     String   @db.VarChar(20)
  // POOL | CAPTACION | REASIGNACION
  lote_id    Int?
  activo     Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  usuario usuarios @relation(fields: [usuario_id], references: [id])
  lote    lotes?   @relation(fields: [lote_id], references: [id])

  @@index([usuario_id, activo])
  @@index([cliente_id, activo])
}

// =============================================
// DATOS DE CONTACTO EDITADOS
// =============================================

model datos_contacto {
  id          Int      @id @default(autoincrement())
  cliente_id  Int
  // Referencia a clientes.id en BD Clientes (sin FK constraint — DBs separadas)
  campo       String   @db.VarChar(50)
  valor       String
  editado_por Int
  created_at  DateTime @default(now())

  editor usuarios @relation(fields: [editado_por], references: [id])

  @@index([cliente_id, campo])
}

// =============================================
// CONFIGURACION GENERAL
// =============================================

model configuracion {
  id    Int    @id @default(autoincrement())
  clave String @unique @db.VarChar(100)
  valor String
}
